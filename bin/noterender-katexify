#!/usr/bin/env node

const getStdin = require('get-stdin');
const cheerio  = require('cheerio');
const katex    = require('katex');

const regex = /^(?:\$\$\s*([\s\S]+)\s*\$\$)|(?:\$\s*([\s\S]+)\s*\$)$/;


function getTeX(text) {
  var match = text.match(regex);
  if (!match) null;
  return {
    TeX: (match[1] || match[2]).trim(),
    displayMode: match[1] ? true : false,
  };
}


getStdin().then(str => {
  const $ = cheerio.load(str);
  $('code').each(function() {
    var code = $(this);
    var info = getTeX(code.text());

    if (!info) {
      return;
    }

    var html = katex.renderToString(info.TeX, {
      displayMode: info.displayMode,
    });
    code.html(html);
  });
  console.log($.html());
});
